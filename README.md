# 1. 문제 정의

인도네시아의 Blitz Electric Mobility는 Electric Motorbike를 활용한 라스트마일 배송 서비스를 제공하는 스타트업 회사입니다. 이들이 요청한 경로 최적화(Batch Optimization) 문제는 다음과 같습니다.

**목표**: 주어진 제약조건을 지키면서 전체 배달경로를 최소화하는 것이 목표입니다. 

제약조건에는 오토바이의 배달용량(무게), 한 경로당 최대 주행거리, time window 등이 있습니다.

## 부가 설명

### 1. 출발지

배송의 종류는 출발지의 위치에 따라 크게 두가지로 나뉠 수 있습니다.

1. Business Hub라는 물류센터가 있는데, 이 물류센터에 있는 물품을 목적지(집)으로 배달하는 배송이 있고
2. 물품이 생산된 공급처(Origin)로 직접 이동한뒤 물품을 목적지로 배달하는 배송이 있습니다.

### 2. Time window (출발시각과 도착시각에의 제한)

각 배송은 주문별로 제한 도착시간이 다릅니다. 도착하기까지 걸리는 시간으로 가능한 값은

```
2 hours, 4 hours, 8 hours (및 기타 x hours 가능), sameday, 24 hours
```

이 존재합니다.

물품은 주문이 생성된 시각(`created_time`)으로부터  x hours 이내에 목적지로 배송이 완료되어야 합니다.

또한 배송은 주문이 생성된 시각 이후부터 pick-up, drop-off가 가능합니다.

### 3. multi-pickup & multi-dropoff

```
Single-pickup vs multi-pickup
Single-pickup & multi-dropoff : Pickup ABC -> Dropoff a -> Dropoff b -> Dropoff c
Multi-pickup & multi-dropoff : Pickup A -> Pickup B -> Dropoff b -> Pickup C -> Dropoff a -> Dropoff c
```

* 해당 문제의 복잡도를 늘리는 조건 중의 하나로, 배송원은 하나의 배달 경로 내에서 여러 출발지를 들릴 수 있습니다. 
* 가지고 있는 모든 물품을 drop-off하지 않아도 거리가 가깝다면 (그리고 오토바이가 물품들을 모두 실을 수 있다면) 다른 출발지를 들려서 pick-up한 후에 배달을 이어나갈 수 있습니다. 
* 데이터 특징상 Business Hub가 아닌 공급처에서 pick-up한 후 배달해야 하는 물품이 많기 때문에 중요한 조건 중에 하나입니다.

### 4. 오토바이 배달용량(무게)

사측에서 구체적인 값을 지정하지는 않았으나 각 오토바이가 실을 수 있는 배달용량에 제한이 있습니다. 
* 데이터에 물품의 부피가 주어지지 않았기 때문에 주어진 값인 무게를 택했습니다. 
* 현실적으로 생각해봤을때 30kg가 적절하다고 생각했습니다.

배달을 하면서 drop-off를 하면 무게가 줄고, 남은 용량에 따라 pick-up 시에 물품을 실을 수 있는데 이때는 무게가 추가됩니다. 누적 배달용량으로 고려하는 것이 아니라 총 무게가 상시 줄수도 있고 늘을 수도 있습니다.

- 모델에서 해당 조건 파라미터는 조정할 수 있게끔 했습니다.

### 5. 한 경로당 최대 주행거리

역시 사측에서 구체적인 값을 지정하지는 않았으나 현실적으로 생각했을 때 120km 정도로 제한을 거는 것이 좋다고 생각했습니다(이후 충전 필요).

- 모델에서 해당 조건 파라미터는 조정할 수 있게끔 했습니다.

# 2. 문제 해결 과정

1. 처음에는 강화학습으로 모델을 만드려 했는데 제약조건이 많이 까다로운 바람에 실패했습니다.
2. 두번째로는 Greedy based method로 시도했는데 거리 줄이는데 성능이 좋지 않아 실패했습니다. 최적화 알고리즘 플로우는 다음과 같습니다.
    - pseudo-code
        ```
      1. 작업할 오토바이 선택 - 현시점으로 제일 이른 오토바이
      2. 오토바이에 적합한 주문 필터링
          - 물류센터에서 오는지, 주문이 할당되지 않았는지, 오토바이가 배달하는 현시점보다 일찍 들어온 주문인지
      3. 할당할 주문 선택
          - 오토바이의 현재 시간과 주문의 시작 시간, 종료 시간을 비교하여 할당 가능한 주문을 선택
          - 비용 계산: 거리 * 남은 시간
          - 비용이 가장 적은 주문을 선택
      4. 그전 (오토바이-주문 쌍)과의 비교
          - 현재 오토바이-주문 쌍과 이전 오토바이-주문 쌍 중 삽입비용이 더 적은 것을 선택
      5. 경로에 주문 추가, (start_time, current_time, end_time) 업데이트
        6. 경로 종료 시 값 업데이트
            - 현재 주문의 소요시간, 길이, 무게가 각각 threshold를 초과하는지 확인
            - 초과 시 경로 종료 및 물류센터 할당
      ```
        
3. 세번째로는 출발지 및 목적지, batch 등 문제상의 개념들을 객체화하려는 시도를 했습니다. 결국엔 최종 버전에 이러한 객체화가 반영되었습니다.
4. 네번째 최종 버전에서는 Greedy 기반으로 google maps api를 활용하여 거리를 최적화하는 알고리즘을 완성했습니다. 최적화 알고리즘 플로우는 다음과 같습니다.
    - pseudo-code
      ```
        1. (while 루프: 주문을 모두 처리할때까지) time window가 이른 순으로 정렬
        2. 가장 빨리 처리해야 하는 위치(pickup or dropoff)를 선택
        3. (while 루프: 후보 주문이 없을때까지) 그 주문으로부터 평균 거리가 가까운 주문을 순차적으로 하나씩 고름 (거리가 일정값 이하여야 함)
        4. 주문 경로 가능한지 확인하고 거리 최소화 시도
        5. 성공 시 추가
        6. 거리 최소화 불가능할 경우 추가 X
        7. while 루프 종료
        8. batch 할당 마무리 및 batch 객체 생성
        9. while 루프 종료, batch 객체 리스트 반환
        ```
      
# 3. 솔루션에 대한 설명
## 특징: 

1. 주문 데이터가 하나씩 새롭게 추가될 때마다 그 시점에 새롭게 최적화됩니다. Greedy 특성이 있고 이는 실시간성으로 최적화하기 위함입니다.
2. 개발 후 현실성이 있어야 한다는 피드백에 따라 배달경로 길이를 계산할때 google maps api를 사용하여 실제 도로 주행거리로 계산되도록 하였습니다.